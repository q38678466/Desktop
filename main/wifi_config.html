<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32 æ§åˆ¶å°</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f2f2f2;
    margin: 0;
    padding: 0;
  }

  /* å®¹å™¨è‡ªé€‚åº” */
  .container {
    margin: 20px auto;
    padding: 0; /* padding ç§»åˆ°å…·ä½“å†…å®¹é‡Œï¼Œä¸ºäº†è®©å¯¼èˆªæ è´´è¾¹ */
    width: 90%;
    max-width: 600px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    overflow: hidden; /* é˜²æ­¢åœ†è§’è¢«å†…éƒ¨å…ƒç´ é®æŒ¡ */
  }

  /* --- æ–°å¢ï¼šå¯¼èˆªæ æ ·å¼ --- */
  .navbar {
    display: flex;
    background-color: #f8f9fa;
    border-bottom: 1px solid #ddd;
  }

  .nav-item {
    flex: 1; /* å¹³å‡åˆ†å¸ƒ */
    padding: 15px 0;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    color: #666;
    transition: background 0.3s, color 0.3s;
  }

  .nav-item:hover {
    background-color: #eee;
  }

  /* é€‰ä¸­çŠ¶æ€ */
  .nav-item.active {
    color: #4CAF50;
    border-bottom: 3px solid #4CAF50;
    background-color: #fff;
  }

  /* --- é¡µé¢å†…å®¹åŒºåŸŸ --- */
  .tab-content {
    display: none; /* é»˜è®¤éšè— */
    padding: 20px;
    animation: fadeIn 0.3s;
  }
  
  /* æ˜¾ç¤ºæ¿€æ´»çš„å†…å®¹ */
  .tab-content.active {
    display: block; 
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* --- åŸæœ‰æ ·å¼ --- */
  h2, h3 { color: #333; margin-top: 0;}

  .input-container, .password-container {
    width: 100%;
    margin: 15px 0;
    position: relative;
    text-align: left;
  }

  input {
    width: 100%;
    box-sizing: border-box;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
  }

  /* ä¿®å¤ï¼šå¯†ç è¾“å…¥æ¡†æ ·å¼è°ƒæ•´ */
  #password { padding-right: 40px; } 
  
  #togglePassword {
    position: absolute; 
    right: 10px; 
    top: 50%; 
    transform: translateY(-50%); 
    background: none; 
    border: none; 
    cursor: pointer; 
    font-size: 18px;
    color: #666;
  }

  button[type="submit"] {
    width: 100%;
    padding: 12px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 10px;
  }
  button:hover { background: #45a049; }

  ul#wifiList {
    list-style: none;
    padding: 0;
    margin: 15px 0;
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 5px;
    background: #fff;
  }

  li {
    padding: 12px;
    border-bottom: 1px solid #eee;
    text-align: left;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
  }
  li:last-child { border-bottom: none; }
  li:hover { background: #e6f0ff; }

  /* å¼¹çª— */
  #dialog {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #dialogBox {
    background: white;
    padding: 20px 40px;
    border-radius: 10px;
    font-size: 18px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  
  /* è®¾ç½®é¡µé¢çš„ä¸€äº›ç®€å•æ ·å¼ç¤ºä¾‹ */
  .settings-group {
    text-align: left;
    margin-bottom: 20px;
  }
  .settings-label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
  }

  /* æ–°å¢ï¼šå•é€‰æŒ‰é’®é€‰é¡¹çš„å®¹å™¨æ ·å¼ */
  .radio-option {
      display: flex; /* å¯ç”¨ Flexbox */
      align-items: center; /* å‚ç›´å±…ä¸­å¯¹é½ radio å’Œ label */
      margin-bottom: 12px; /* å¢åŠ é€‰é¡¹é—´çš„å‚ç›´é—´è· */
  }

  .radio-option input[type="radio"] {
      width: 20px; /* æ§åˆ¶ radio æŒ‰é’®æœ¬èº«çš„å®½åº¦ */
      height: 20px; /* æ§åˆ¶ radio æŒ‰é’®æœ¬èº«çš„é«˜åº¦ */
      margin-right: 10px; /* radio å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
      flex-shrink: 0; /* é˜²æ­¢ radio æŒ‰é’®åœ¨å°å±å¹•ä¸Šè¢«å‹ç¼© */
  }

  .radio-option label {
      flex-grow: 1; /* å…è®¸æ ‡ç­¾æ–‡å­—å æ®å‰©ä½™ç©ºé—´ */
      cursor: pointer; /* ä¿æŒ label å¯ç‚¹å‡» */
      margin: 0; /* ç§»é™¤é»˜è®¤çš„ margin */
      padding-top: 2px; /* å¾®è°ƒæ–‡å­—çš„å‚ç›´ä½ç½®ï¼Œä½¿å…¶ä¸ radio æ›´å¯¹é½ */
  }
</style>
</head>
<body>

<div class="container">
  
  <div class="navbar">
    <div class="nav-item active" onclick="switchTab('wifi')">é…ç½‘</div>
    <div class="nav-item" onclick="switchTab('settings')">è®¾ç½®</div>
  </div>

  <div id="view-wifi" class="tab-content active">
    <h2>WiFi è¿æ¥</h2>
    <form>
      <div class="input-container">
        <input type="text" id="ssid" name="ssid" placeholder="è¯·è¾“å…¥æˆ–é€‰æ‹© WiFi" required>
      </div>

      <div class="password-container">
        <input type="password" id="password" name="password" placeholder="WiFi å¯†ç " required>
        <button type="button" id="togglePassword">ğŸ‘ï¸</button>
      </div>

      <button type="submit">è¿æ¥ç½‘ç»œ</button>
    </form>

    <h3>é™„è¿‘ WiFi</h3>
    <ul id="wifiList">
      <li style="justify-content:center; color:#888;">æ­£åœ¨æ‰«æ...</li>
    </ul>
  </div>

  <div id="view-settings" class="tab-content">
    <h2>ç³»ç»Ÿè®¾ç½®</h2>
    
    <div class="settings-group">
        <label class="settings-label" for="targetDate">çºªå¿µæ—¥æœŸ</label>
        <input type="date" id="targetDate" required>
    </div>

    <div class="settings-group" style="text-align: left;">
        <label class="settings-label">ESP32 å¾…æœºç•Œé¢é€‰æ‹©</label>
        
        <div class="radio-option"> 
            <input type="radio" id="modeClock" name="standbyMode" value="weather" checked>
            <label for="modeClock">æ¨¡å¼ä¸€ï¼šæ˜¾ç¤ºå¤©æ°”é¢„æŠ¥</label>
        </div>
        
        <div class="radio-option">
            <input type="radio" id="modeWelcome" name="standbyMode" value="anniversary">
            <label for="modeWelcome">æ¨¡å¼äºŒï¼šæ˜¾ç¤ºçºªå¿µæ—¥</label>
        </div>
    </div>

    <button type="submit" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
    
    <div style="margin-top: 20px; font-size: 12px; color: #999;">
        <div>Firmware v1.0.0  ä½œè€…: Sharp</div>
        <div>å¾®ä¿¡ï¼šhfb386</div>
    </div>
  </div>

</div>

<div id="dialog">
  <div id="dialogBox">è¿æ¥ä¸­...</div>
</div>

<script>
  // ä¿å­˜è®¾ç½®æŒ‰é”®å›è°ƒ
  async function saveSettings() {
    // 1. è·å–é€‰ä¸­çš„æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
    const dateInput = document.getElementById('targetDate');
    const selectedDateStr = dateInput.value; 

    // 2. è·å–å¾…æœºæ¨¡å¼
    // document.querySelector('[name="standbyMode"]:checked') æ‰¾åˆ° name ä¸º standbyMode ä¸”è¢«é€‰ä¸­çš„ radio æŒ‰é’®
    const selectedModeElement = document.querySelector('input[name="standbyMode"]:checked');
    const standbyMode = selectedModeElement ? selectedModeElement.value : 'weather'; // é»˜è®¤å€¼ 'clock'

    // 3. æ ¡éªŒæ—¥æœŸæ˜¯å¦ä¸ºç©º
    if (!selectedDateStr) {
        alert("è¯·é€‰æ‹©ä¸€ä¸ªç›®æ ‡æ—¥æœŸï¼");
        dateInput.focus();
        return;
    }
    // è½¬æ¢ä¸º UTC 00:00:00 çš„æ—¶é—´æˆ³
    let unixTimestampSeconds;
    try {
        // æ–¹æ³•1ï¼šç®€å•ç›´æ¥
        const dateStrWithTime = `${selectedDateStr}T00:00:00`;
        const dateObject = new Date(dateStrWithTime);
        
        // éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        if (isNaN(dateObject.getTime())) {
            throw new Error("æ— æ•ˆçš„æ—¥æœŸæ ¼å¼");
        }
        
        unixTimestampSeconds = Math.floor(dateObject.getTime() / 1000);
        
        // è°ƒè¯•ä¿¡æ¯
        console.log("é€‰æ‹©çš„æ—¥æœŸ:", selectedDateStr);
        console.log("æ—¶é—´æˆ³ (ç§’):", unixTimestampSeconds);
        console.log("UTC æ—¶é—´:", new Date(unixTimestampSeconds * 1000).toUTCString());
        console.log("æœ¬åœ°æ—¶é—´:", new Date(unixTimestampSeconds * 1000).toString());
        console.log("å¾…æœºæ¨¡å¼:", standbyMode);
        
    } catch (error) {
        console.error("æ—¥æœŸè½¬æ¢é”™è¯¯:", error);
        showDialog("âŒ æ—¥æœŸæ ¼å¼é”™è¯¯");
        return;
    }

    try {
      const res = await fetch("/savesettings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({date: unixTimestampSeconds, standbyMode})
      });
      // å…¼å®¹ç›´æ¥è¿”å›æ–‡æœ¬æˆ–JSON
      let status = "error";
      try {
          const data = await res.json();
          status = data.status;
      } catch(e) { console.log("Non-JSON response"); }

      if(res.ok || status === "ok") showDialog("âœ… è®¾ç½®å·²ä¿å­˜ï¼");
      else showDialog("âŒ ä¿å­˜è¯·æ±‚å¤±è´¥");
      
    } catch(err) {
      showDialog("âŒ å‘é€è¯·æ±‚å¤±è´¥");
    }
    //è®¾ç½®3ç§’åè‡ªåŠ¨å…³é—­å¼¹çª—
    setTimeout(hideDialog, 3000);
  }

  // --- æ–°å¢ï¼šTab åˆ‡æ¢é€»è¾‘ ---
  function switchTab(tabName) {
    // 1. å¤„ç†å¯¼èˆªæ æ ·å¼
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active');
    });
    // æ ¹æ®ç‚¹å‡»çš„æ˜¯å“ªä¸ªtabï¼Œæ·»åŠ activeç±» (ç®€å•åˆ¤æ–­æ–‡æœ¬)
    const items = document.querySelectorAll('.nav-item');
    if(tabName === 'wifi') items[0].classList.add('active');
    else items[1].classList.add('active');

    // 2. å¤„ç†å†…å®¹æ˜¾ç¤º
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById('view-' + tabName).classList.add('active');
  }

  // --- åŸæœ‰é€»è¾‘ ---

  // å¼¹çª—æ§åˆ¶
  function showDialog(msg) {
    document.getElementById('dialogBox').innerText = msg;
    document.getElementById('dialog').style.display = 'flex';
  }
  function hideDialog() {
    document.getElementById('dialog').style.display = 'none';
  }

  // å¯†ç å¯è§åˆ‡æ¢
  document.getElementById('togglePassword').addEventListener('click', () => {
    const password = document.getElementById('password');
    const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
    password.setAttribute('type', type);
    // åˆ‡æ¢å›¾æ ‡
    document.getElementById('togglePassword').textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ”“';
  });

  // é€‰æ‹© WiFi
  function selectWifi(ssid) {
    document.getElementById('ssid').value = ssid;
    // åˆ‡æ¢å›é…ç½‘Tab (é˜²æ­¢ç”¨æˆ·åœ¨è®¾ç½®é¡µç‚¹å‡»äº†ä»€ä¹ˆå¯¼è‡´é”™ä¹±ï¼Œè™½ç„¶ç›®å‰é€»è¾‘ä¸ä¼š)
    switchTab('wifi'); 
    document.getElementById('password').focus();
  }

  // åŠ è½½ WiFi åˆ—è¡¨
  async function loadWifiList() {
    try {
      // æ¨¡æ‹Ÿæ•°æ® (å¦‚æœä½ åœ¨ç”µè„‘ä¸Šæµ‹è¯•ï¼Œå¯ä»¥è§£å¼€ä¸‹é¢è¿™è¡Œæ³¨é‡Š)
      // const list = ["WiFi_Home_5G", "ChinaNet-Dx88", "ESP32-AP"]; 
      
      const res = await fetch('/scan'); // ESP32 çœŸå®ç¯å¢ƒ
      const list = await res.json();
      
      const ul = document.getElementById('wifiList');
      ul.innerHTML = '';
      if(list.length === 0) { 
        ul.innerHTML='<li style="justify-content:center;">æœªæ‰¾åˆ°å¯ç”¨WiFi</li>'; 
        return; 
      }
      list.forEach(ap => {
        const li = document.createElement('li');
        // å‡è®¾ ap åªæ˜¯å­—ç¬¦ä¸² SSIDï¼Œå¦‚æœ ESP32 è¿”å›çš„æ˜¯å¯¹è±¡ {ssid, rssi} éœ€è¦å¯¹åº”ä¿®æ”¹
        li.innerHTML = `<span>${ap}</span> <span style="color:#aaa;">ğŸ“¶</span>`;
        li.onclick = () => selectWifi(ap);
        ul.appendChild(li);
      });
    } catch(err) {
      document.getElementById('wifiList').innerHTML='<li style="justify-content:center; color:red;">æ‰«æå¤±è´¥æˆ–APIæœªå“åº”</li>';
      console.error(err);
    }
  }

  // è¿æ¥ WiFi
  async function connectWifi() {
    const ssid = document.getElementById('ssid').value;
    const password = document.getElementById('password').value;
    if(!ssid) { alert("è¯·è¾“å…¥WiFiåç§°"); return; }

    showDialog("æ­£åœ¨è¿æ¥ " + ssid + " ...");

    try {
      const res = await fetch("/connect", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ssid, password})
      });
      let data = null;
      let status = "error";
      
      try {
        data = await res.json();
        status = data.status || "error";
      } catch(e) {
        console.log("Non-JSON response or parse error:", e);
      }
      
      // ä¿®æ”¹åˆ¤æ–­é€»è¾‘
      if(status === "ok") {
        showDialog("âœ… è¿æ¥æˆåŠŸï¼");
      } else {
        // å¦‚æœæœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯å¯ä»¥æ˜¾ç¤º
        const errorMsg = data && data.message ? data.message : "è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ";
        showDialog(`âŒ ${errorMsg}`);
      }
    } catch(err) {
      console.error("è¯·æ±‚å¤±è´¥:", err);
      showDialog("âŒ å‘é€è¯·æ±‚å¤±è´¥");
    }
    
    setTimeout(hideDialog, 3000);
  }

  window.onload = function() {
    loadWifiList();
    document.querySelector("form").addEventListener("submit", e => {
      e.preventDefault();
      connectWifi();
    });
  }
</script>
</body>
</html>